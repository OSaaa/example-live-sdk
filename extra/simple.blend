#!/usr/bin/env zsh
# minimal.blend


source "$configfile"


blend_preinst() {
	fn blend_preinst
	req=(strapdir blend)
	ckreq || return 1

	notice "executing $blend_name preinst"

	add-user "$loginname" "$password"
	
}


blend_postinst() {
	fn blend_postinst
	req=(strapdir)
	ckreq || return 1

	notice "executing $blend_name postinst"
		
# copy rootfs_overlay	
	notice "grabbing rootfs-overlay"
	pushd "$strapdir"
	
	# overlay is local directory
	sudo rsync -avx "$rootfs_overlay" . || zerr

	# overlay is git repo
	#sudo git clone "$rootfs_overlay" || zerr
	#sudo mv -v   rootfs-overlay/.git . || zerr
	#sudo cp -rav rootfs-overlay/* .    || zerr
	#sudo rm -rf  rootfs-overlay

	popd

	blend_finalize || zerr
}


blend_finalize() {
	fn blend_finalize
	req=(strapdir)
	ckreq || return 1

	cat <<EOF | sudo tee ${strapdir}/finalize >/dev/null
#!/bin/sh
# finalize
set -x
exec 2>finalize.log


## perms

	for i in cdrom floppy audio dip video plugdev netdev ; do   # lpadmin scanner  # put this in config file?
		gpasswd -a "$loginname" \${i}
	done
	
	chsh -s "$user_default_shell" "$loginname"
	chown -R 1000:1000 /home/"$loginname"

	
	
# What's this? Do I need it?
rm -rf /usr/local/share/zsh/site-functions


# remove fstab for iso. This should probably be in iso_prepare_strap
rm -f /etc/fstab


## cleanup

apt-get --yes --force-yes purge ${finalize_purge_packages}
apt-get --yes --force-yes autoremove
apt-get clean
updatedb
EOF
	chroot-script finalize || zerr
	
	sudo chmod 666 "$strapdir"/*.log
	sudo mv "$strapdir"/*.log "$R/extra/logs"
	
}
